<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockStream - AI Market Tracker (1,000+ Companies)</title>
    <!-- 1. INTEGRATED TRADINGVIEW SCRIPT -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        :root {
            --bg-color: #0f0f0f;
            --card-bg: #1e1e1e;
            --card-hover: #2a2a2a;
            --text-main: #ffffff;
            --text-dim: #aaaaaa;
            --accent: #3ea6ff;
            --gold: #ffd700;
            --green: #2ba640;
            --red: #ff4e4e;
            --border: #333;
            --modal-bg: #181818;
        }

        body {
            font-family: "Roboto", "Segoe UI", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            overflow-x: hidden;
        }

        /* --- TICKER BAR --- */
        .ticker-wrap {
            width: 100%;
            overflow: hidden;
            background-color: #161616;
            border-bottom: 1px solid var(--border);
            padding: 12px 0;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .ticker {
            display: inline-block;
            padding-left: 100%;
            animation: ticker-animation 90s linear infinite;
        }

        .ticker:hover { animation-play-state: paused; }

        .ticker-item {
            display: inline-block;
            padding: 0 30px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .ticker-item span { margin-left: 6px; }
        .ticker-item .up { color: var(--green); }
        .ticker-item .down { color: var(--red); }

        @keyframes ticker-animation {
            0% { transform: translate3d(0, 0, 0); }
            100% { transform: translate3d(-100%, 0, 0); }
        }

        /* --- HEADER --- */
        .header {
            padding: 40px 20px 20px;
            text-align: center;
        }

        .header h1 {
            margin: 0 0 10px 0;
            font-size: 3rem;
            letter-spacing: -1px;
            background: linear-gradient(90deg, #fff, #3ea6ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle { color: var(--text-dim); font-size: 1.1rem; margin-bottom: 30px; }

        /* --- SECTIONS --- */
        .section-container {
            max-width: 1400px;
            margin: 0 auto 40px;
            padding: 0 20px;
        }

        .section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        /* --- INVESTMENT PICKS SECTION (NEW) --- */
        .picks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .pick-card {
            background: linear-gradient(160deg, #1a1a1a, #222);
            border: 1px solid #444;
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .pick-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, var(--gold), var(--accent));
        }

        .pick-card:hover {
            transform: translateY(-8px);
            border-color: var(--accent);
            box-shadow: 0 15px 40px rgba(62, 166, 255, 0.15);
        }

        .pick-badge {
            background: rgba(255, 215, 0, 0.15);
            color: var(--gold);
            font-size: 0.75rem;
            font-weight: 800;
            padding: 4px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            display: inline-block;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .pick-symbol { font-size: 1.8rem; font-weight: 800; color: #fff; margin-bottom: 4px; }
        .pick-name { font-size: 0.9rem; color: #bbb; margin-bottom: 15px; }
        
        .pick-reason {
            font-size: 0.85rem;
            color: #ddd;
            line-height: 1.5;
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 3px solid var(--accent);
        }

        .pick-price-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 15px;
        }
        
        .pick-price { font-size: 1.4rem; font-weight: 700; }
        .pick-change { font-weight: 600; }

        /* --- MOVERS GRID (SMALLER CARDS) --- */
        .movers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
        }

        .mover-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            border-left: 3px solid transparent;
        }

        .mover-card:hover { transform: translateY(-4px); background: var(--card-hover); }
        .mover-card.up { border-left-color: var(--green); }
        .mover-card.down { border-left-color: var(--red); }
        
        .mover-symbol { font-weight: bold; font-size: 1.1rem; }
        .mover-price { font-size: 1rem; margin-top: 5px; color: #ccc; }
        .mover-change { font-size: 0.9rem; margin-top: 2px; }

        /* --- SEARCH --- */
        .search-container {
            max-width: 800px;
            margin: 0 auto 30px;
            padding: 0 20px;
        }

        #searchInput {
            width: 100%;
            padding: 18px 30px;
            border-radius: 50px;
            border: 1px solid var(--border);
            background: #1a1a1a;
            color: white;
            font-size: 1.1rem;
            box-sizing: border-box;
            outline: none;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        #searchInput:focus { border-color: var(--accent); box-shadow: 0 0 20px rgba(62, 166, 255, 0.2); }

        /* --- MAIN GRID --- */
        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            padding: 0 40px 80px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .stock-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid transparent;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 120px;
        }

        .stock-card:hover {
            transform: translateY(-4px);
            background: var(--card-hover);
            border-color: #444;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .symbol { margin: 0; font-size: 18px; font-weight: 700; color: var(--accent); }
        .company-name { margin: 5px 0 0; color: var(--text-dim); font-size: 11px; line-height: 1.3; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .stock-price { font-weight: 700; font-size: 20px; }
        .stock-change { font-size: 13px; font-weight: 600; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.05); }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-overlay.open { display: flex; opacity: 1; }

        .modal-content {
            background: var(--modal-bg);
            width: 90%;
            max-width: 950px;
            border-radius: 16px;
            padding: 30px;
            border: 1px solid #444;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            position: relative;
            max-height: 95vh;
            overflow-y: auto;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: #fff;
            font-size: 28px;
            cursor: pointer;
            z-index: 10;
        }

        .modal-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 20px; }
        .modal-symbol { font-size: 2.5rem; margin: 0; color: var(--accent); line-height: 1; }
        .modal-name { font-size: 1rem; color: var(--text-dim); margin: 5px 0 0; }
        .modal-price-block { text-align: right; }
        .modal-price { font-size: 2rem; font-weight: bold; }
        
        .chart-container {
            width: 100%;
            height: 450px;
            background: #000;
            border-radius: 12px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            border: 1px solid #333;
        }
        
        /* AI PANEL */
        .ai-panel {
            background: #111;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .ai-title {
            color: var(--accent);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-badge {
            background: var(--accent);
            color: black;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 800;
        }

        .recommendation { font-size: 1.8rem; font-weight: 800; }
        .rec-buy { color: var(--green); }
        .rec-sell { color: var(--red); }
        .rec-hold { color: #f1c40f; }

        .confidence-bar {
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            width: 100%;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #fff);
            width: 0%;
            transition: width 1s ease-out;
        }

        /* --- LOADING --- */
        .loading-trigger { text-align: center; padding: 40px; color: var(--text-dim); display: none; }
        .loading-trigger.active { display: block; }
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 30px; height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .stock-grid { grid-template-columns: repeat(2, 1fr); padding: 0 10px; }
            .modal-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .modal-price-block { text-align: left; }
            .header h1 { font-size: 2rem; }
            .picks-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="ticker-wrap">
        <div class="ticker" id="tickerContent"></div>
    </div>

    <div class="header">
        <h1>StockStream Pro</h1>
        <div class="subtitle" id="stockCountDisplay">Initializing AI Market Tracker...</div>
    </div>

    <!-- NEW SECTION: INVESTMENT PICKS -->
    <div class="section-container">
        <div class="section-title">
            <span style="font-size:1.5em">ðŸš€</span> Top Investment Picks (2025-2026 Forecast)
        </div>
        <div class="picks-grid" id="picksGrid">
            <!-- Populated by JS -->
        </div>
    </div>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Search 5,000+ companies (LULU, NVDA, AAPL...)" autocomplete="off">
    </div>

    <!-- MARKET MOVERS -->
    <div class="section-container">
        <div class="section-title">
            <span style="font-size:1.5em">ðŸ”¥</span> Top Market Movers (24h)
        </div>
        <div class="movers-grid" id="moversGrid"></div>
    </div>

    <!-- ALL STOCKS -->
    <div class="section-container">
        <div class="section-title">
            <span style="font-size:1.5em">ðŸ“Š</span> All Listings
        </div>
        <div id="stockGrid" class="stock-grid"></div>
    </div>
    
    <div id="loadingTrigger" class="loading-trigger">
        <div class="loader"></div>
        <span>Loading more assets...</span>
    </div>

    <!-- MODAL -->
    <div id="modalOverlay" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="close-btn" onclick="closeModalDirect()">Ã—</button>
            
            <div class="modal-header">
                <div>
                    <h1 id="mSymbol" class="modal-symbol">---</h1>
                    <p id="mName" class="modal-name">---</p>
                </div>
                <div class="modal-price-block">
                    <div id="mPrice" class="modal-price">$0.00</div>
                    <div id="mChange" style="font-weight:bold;">0.00%</div>
                </div>
            </div>

            <div class="chart-container" id="tv_chart_container"></div>

            <div class="ai-panel">
                <div class="ai-title"><span class="ai-badge">AI ANALYST</span> PREDICTION MODEL</div>
                <div class="recommendation" id="aiRec">Analyzing...</div>
                <p id="aiText" style="color: #ccc; font-size: 1rem; line-height: 1.6;">
                    Loading market sentiment and technical indicators...
                </p>
                <div style="display:flex; justify-content:space-between; margin-top:15px; font-size:0.8rem; color:#888;">
                    <span>Confidence Score</span>
                    <span id="aiConfVal">0%</span>
                </div>
                <div class="confidence-bar">
                    <div id="aiConfFill" class="confidence-fill"></div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- 1. INVESTMENT PICKS (Curated for 2025/2026) ---
    const investmentPicks = [
        { s: "NVDA", n: "NVIDIA Corp", badge: "AI INFRASTRUCTURE", reason: "Unrivaled dominance in AI chips (GPUs). As AI adoption scales globally, NVDA remains the primary beneficiary of data center spend." },
        { s: "PLTR", n: "Palantir Tech", badge: "AI SOFTWARE", reason: "Strong commercial sector growth. Their AIP (Artificial Intelligence Platform) is seeing rapid enterprise adoption." },
        { s: "AMZN", n: "Amazon.com", badge: "CLOUD & RETAIL", reason: "Undervalued relative to AWS growth. massive logistics moat plus high-margin advertising and cloud services." },
        { s: "MELI", n: "MercadoLibre", badge: "EMERGING MARKETS", reason: "The 'Amazon of Latin America'. Dominates e-commerce and fintech in high-growth regions like Brazil and Mexico." },
        { s: "AVGO", n: "Broadcom Inc.", badge: "CUSTOM SILICON", reason: "Critical player in networking and custom AI chips for major tech giants. High dividend yield plus growth." },
        { s: "MSFT", n: "Microsoft", badge: "ENTERPRISE AI", reason: "Safe haven for AI exposure via Azure and Copilot. Deep integration into enterprise software makes it a stable long-term hold." },
        { s: "PYPL", n: "PayPal Holdings", badge: "VALUE PLAY", reason: "Currently trading at historical lows. New management and 'Fastlane' checkout tech signal a strong turnaround potential." },
        { s: "CAT", n: "Caterpillar Inc.", badge: "INFRASTRUCTURE", reason: "Global construction boom and onshoring of manufacturing benefit CAT directly. A solid industrial hedge." }
    ];

    // --- 2. EXTENSIVE CORE LIST (Ensures populated UI immediately) ---
    const coreStocks = [
        ...investmentPicks,
        { s: "AAPL", n: "Apple Inc." }, { s: "GOOGL", n: "Alphabet Inc." }, { s: "META", n: "Meta Platforms" }, { s: "TSLA", n: "Tesla Inc." },
        { s: "BRK.B", n: "Berkshire Hathaway" }, { s: "V", n: "Visa Inc." }, { s: "JPM", n: "JPMorgan Chase" }, { s: "UNH", n: "UnitedHealth" },
        { s: "LLY", n: "Eli Lilly" }, { s: "XOM", n: "Exxon Mobil" }, { s: "MA", n: "Mastercard" }, { s: "PG", n: "Procter & Gamble" },
        { s: "HD", n: "Home Depot" }, { s: "COST", n: "Costco" }, { s: "JNJ", n: "Johnson & Johnson" }, { s: "MRK", n: "Merck & Co." },
        { s: "ABBV", n: "AbbVie Inc." }, { s: "CVX", n: "Chevron Corp" }, { s: "AMD", n: "Advanced Micro Devices" }, { s: "ADBE", n: "Adobe Inc." },
        { s: "PEP", n: "PepsiCo Inc." }, { s: "CRM", n: "Salesforce" }, { s: "KO", n: "Coca-Cola" }, { s: "BAC", n: "Bank of America" },
        { s: "WMT", n: "Walmart" }, { s: "TMO", n: "Thermo Fisher" }, { s: "ACN", n: "Accenture" }, { s: "NFLX", n: "Netflix" },
        { s: "MCD", n: "McDonald's" }, { s: "INTU", n: "Intuit" }, { s: "DIS", n: "Walt Disney" }, { s: "LIN", n: "Linde PLC" },
        { s: "CSCO", n: "Cisco Systems" }, { s: "ORCL", n: "Oracle" }, { s: "ABT", n: "Abbott Labs" }, { s: "DHR", n: "Danaher" },
        { s: "GE", n: "General Electric" }, { s: "CAT", n: "Caterpillar" }, { s: "VZ", n: "Verizon" }, { s: "TXN", n: "Texas Instruments" },
        { s: "INTC", n: "Intel Corp" }, { s: "PM", n: "Philip Morris" }, { s: "AMAT", n: "Applied Materials" }, { s: "AXP", n: "American Express" },
        { s: "UBER", n: "Uber Tech" }, { s: "QCOM", n: "Qualcomm" }, { s: "LOW", n: "Lowe's" }, { s: "IBM", n: "IBM Corp" },
        { s: "SPGI", n: "S&P Global" }, { s: "GS", n: "Goldman Sachs" }, { s: "COP", n: "ConocoPhillips" }, { s: "RTX", n: "RTX Corp" },
        { s: "SYK", n: "Stryker" }, { s: "MS", n: "Morgan Stanley" }, { s: "HON", n: "Honeywell" }, { s: "NEE", n: "NextEra Energy" },
        { s: "BKNG", n: "Booking Holdings" }, { s: "BLK", n: "BlackRock" }, { s: "PFE", n: "Pfizer" }, { s: "T", n: "AT&T" },
        { s: "VRTX", n: "Vertex Pharma" }, { s: "SBUX", n: "Starbucks" }, { s: "AMGN", n: "Amgen" }, { s: "TJX", n: "TJX Companies" },
        { s: "CVS", n: "CVS Health" }, { s: "LMT", n: "Lockheed Martin" }, { s: "BA", n: "Boeing" }, { s: "SHOP", n: "Shopify" },
        { s: "SNOW", n: "Snowflake" }, { s: "ABNB", n: "Airbnb" }, { s: "SPOT", n: "Spotify" }, { s: "WDAY", n: "Workday" },
        { s: "COIN", n: "Coinbase" }, { s: "SQ", n: "Block Inc." }, { s: "ZM", n: "Zoom Video" }, { s: "DOCU", n: "DocuSign" },
        { s: "RIVN", n: "Rivian" }, { s: "LCID", n: "Lucid Group" }, { s: "MSTR", n: "MicroStrategy" }, { s: "BILI", n: "Bilibili" },
        { s: "DKNG", n: "DraftKings" }, { s: "HOOD", n: "Robinhood" }, { s: "ROKU", n: "Roku" }, { s: "U", n: "Unity" },
        { s: "GME", n: "GameStop" }, { s: "AMC", n: "AMC Ent" }, { s: "NKE", n: "Nike" }, { s: "LULU", n: "Lululemon" }
    ];

    let allStocks = [];
    let currentFilteredStocks = [];
    let displayCount = 0;
    const PAGE_SIZE = 50;
    let stockDataCache = {};

    // --- 3. DATA GENERATION ---
    function getStockData(symbol) {
        if (stockDataCache[symbol]) return stockDataCache[symbol];
        
        // Pseudo-random generation based on symbol string to keep consistency
        let hash = 0;
        for (let i = 0; i < symbol.length; i++) hash = symbol.charCodeAt(i) + ((hash << 5) - hash);
        
        // Make prices realistic based on "blue chip" vs others
        let basePrice = (Math.abs(hash) % 500) + 15; 
        if(investmentPicks.some(p => p.s === symbol)) basePrice += 100; // Boost price for top picks slightly

        const volatility = (Math.abs(hash) % 8) + 1.5; 
        let history = [];
        let current = basePrice;
        
        // Generate 30 days of "history"
        for(let i=0; i<30; i++) {
            history.push(current);
            let change = (Math.random() - 0.5) * volatility;
            current += change;
            if(current < 1) current = 1;
        }
        
        const finalPrice = history[history.length - 1];
        const startPrice = history[0];
        const changePercent = ((finalPrice - startPrice) / startPrice) * 100;
        
        stockDataCache[symbol] = {
            price: finalPrice.toFixed(2),
            change: changePercent.toFixed(2),
            isUp: changePercent >= 0,
            history: history
        };
        return stockDataCache[symbol];
    }

    // --- 4. RENDERERS ---
    
    // Render "Invest In" Picks
    function renderInvestmentPicks() {
        const grid = document.getElementById('picksGrid');
        grid.innerHTML = '';
        investmentPicks.forEach(stock => {
            const data = getStockData(stock.s);
            const color = data.isUp ? 'var(--green)' : 'var(--red)';
            
            const card = document.createElement('div');
            card.className = 'pick-card';
            card.onclick = () => openModal(stock);
            
            card.innerHTML = `
                <div class="pick-badge">${stock.badge}</div>
                <div class="pick-symbol">${stock.s}</div>
                <div class="pick-name">${stock.n}</div>
                <div class="pick-reason">${stock.reason}</div>
                <div class="pick-price-row">
                    <div class="pick-price">$${data.price}</div>
                    <div class="pick-change" style="color:${color}">${data.isUp?'+':''}${data.change}%</div>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    // Render "Top Movers"
    function renderMovers() {
        // Calculate top movers from the known list
        const sorted = [...allStocks]
            .map(s => ({...s, data: getStockData(s.s)}))
            .sort((a, b) => Math.abs(parseFloat(b.data.change)) - Math.abs(parseFloat(a.data.change))); // Sort by absolute volatility
        
        const grid = document.getElementById('moversGrid');
        grid.innerHTML = '';
        
        // Show top 8 movers
        sorted.slice(0, 8).forEach(stock => {
            const data = stock.data;
            const card = document.createElement('div');
            card.className = `mover-card ${data.isUp ? 'up' : 'down'}`;
            card.onclick = () => openModal(stock);
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <span class="mover-symbol">${stock.s}</span>
                    <span class="mover-change" style="color:${data.isUp ? 'var(--green)' : 'var(--red)'}">
                        ${data.isUp?'+':''}${data.change}%
                    </span>
                </div>
                <div class="mover-price">$${data.price}</div>
            `;
            grid.appendChild(card);
        });
    }

    function createStockCard(stock) {
        const data = getStockData(stock.s);
        const colorHex = data.isUp ? '#2ba640' : '#ff4e4e';
        const sign = data.isUp ? '+' : '';
        const div = document.createElement('div');
        div.className = 'stock-card';
        div.onclick = () => openModal(stock);
        div.innerHTML = `
            <div>
                <div class="card-header">
                    <h3 class="symbol">${stock.s}</h3>
                    <div class="stock-change" style="color:${colorHex}">${sign}${data.change}%</div>
                </div>
                <p class="company-name">${stock.n}</p>
            </div>
            <div style="margin-top:auto">
                <div class="stock-price">$${data.price}</div>
            </div>`;
        return div;
    }

    function renderBatch() {
        const grid = document.getElementById('stockGrid');
        const trigger = document.getElementById('loadingTrigger');
        const nextBatch = currentFilteredStocks.slice(displayCount, displayCount + PAGE_SIZE);
        
        const fragment = document.createDocumentFragment();
        nextBatch.forEach(stock => fragment.appendChild(createStockCard(stock)));
        grid.appendChild(fragment);
        
        displayCount += nextBatch.length;
        trigger.className = (displayCount < currentFilteredStocks.length) ? 'loading-trigger active' : 'loading-trigger';
    }

    // --- 5. MODAL & AI LOGIC ---
    function openModal(stock) {
        const data = getStockData(stock.s);
        document.getElementById('mSymbol').innerText = stock.s;
        document.getElementById('mName').innerText = stock.n;
        document.getElementById('mPrice').innerText = `$${data.price}`;
        const color = data.isUp ? 'var(--green)' : 'var(--red)';
        document.getElementById('mChange').innerHTML = `<span style="color:${color}">${data.isUp?'+':''}${data.change}% (24h)</span>`;
        
        document.getElementById('modalOverlay').classList.add('open');
        document.body.style.overflow = 'hidden';
        
        // TradingView Widget
        document.getElementById('tv_chart_container').innerHTML = '';
        new TradingView.widget({
            "autosize": true,
            "symbol": stock.s,
            "interval": "D",
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "1",
            "locale": "en",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "hide_side_toolbar": false,
            "allow_symbol_change": true,
            "container_id": "tv_chart_container"
        });

        generateAIAnalysis(data.change, stock.n);
    }

    function closeModalDirect() {
        document.getElementById('modalOverlay').classList.remove('open');
        document.body.style.overflow = '';
    }
    
    function closeModal(e) { if (e.target.id === 'modalOverlay') closeModalDirect(); }

    function generateAIAnalysis(changeStr, name) {
        const change = parseFloat(changeStr);
        const recEl = document.getElementById('aiRec');
        const textEl = document.getElementById('aiText');
        const confVal = document.getElementById('aiConfVal');
        const confFill = document.getElementById('aiConfFill');
        
        let sentiment, explanation, cssClass;
        // Simple logic for demo: In reality, this would query a backend API
        const confidence = Math.min(Math.floor(Math.abs(change) * 5) + 65, 98); 

        if (change < -2.5) {
            sentiment = "STRONG BUY (OVERSOLD)";
            cssClass = "rec-buy";
            explanation = `<strong>${name}</strong> is currently trading significantly below its recent average. Our algorithms detect this as an overreaction to short-term volatility. Accumulation is recommended at these levels for a potential bounce.`;
        } else if (change >= -2.5 && change < 0.5) {
            sentiment = "HOLD / NEUTRAL";
            cssClass = "rec-hold";
            explanation = `<strong>${name}</strong> is consolidating. Technical indicators (RSI, MACD) are showing neutral signals. We recommend waiting for a breakout above resistance or a clearer trend before increasing positions.`;
        } else if (change >= 0.5 && change < 5.0) {
            sentiment = "BUY (MOMENTUM)";
            cssClass = "rec-buy";
            explanation = `<strong>${name}</strong> is exhibiting healthy upward momentum backed by volume. The trend is bullish, and the stock is well-positioned for continued growth in the short-to-mid term.`;
        } else {
            sentiment = "SELL / TAKE PROFIT";
            cssClass = "rec-sell";
            explanation = `<strong>${name}</strong> has rallied extensively (+${changeStr}%) and is entering overbought territory. We recommend trimming positions to lock in gains before a potential mean reversion or correction.`;
        }

        recEl.innerText = "Processing...";
        confFill.style.width = "0%";
        
        setTimeout(() => {
            recEl.innerText = sentiment;
            recEl.className = `recommendation ${cssClass}`;
            textEl.innerHTML = explanation;
            confVal.innerText = `${confidence}%`; 
            confFill.style.width = `${confidence}%`;
        }, 800);
    }

    // --- 6. DATA FETCHING (4,000+ STOCKS) ---
    async function fetchAllNasdaq() {
        try {
            // Fetching a large dataset of Nasdaq listings
            const response = await fetch('https://pkgstore.datahub.io/core/nasdaq-listings/nasdaq-listed_json/data/a5bc7580d6176d60ac0b21b650e7a17f/nasdaq-listed_json.json');
            const data = await response.json();
            
            // Deduplicate against core stocks
            const coreSymbols = new Set(coreStocks.map(c => c.s));
            const newStocks = data
                .filter(item => !coreSymbols.has(item.Symbol))
                .map(item => ({ s: item.Symbol, n: item["Company Name"] }));
            
            // Merge lists
            allStocks = [...coreStocks, ...newStocks];
            
            // Refresh counts
            document.getElementById('stockCountDisplay').innerText = `Tracking ${allStocks.length.toLocaleString()} Active Companies`;
            
            // If user hasn't searched yet, update the grid background data (don't force re-render of everything immediately to save perf)
            if (document.getElementById('searchInput').value === '') {
                currentFilteredStocks = [...allStocks];
            }
        } catch (e) {
            console.warn("External fetch failed. Using Seed List.", e);
            document.getElementById('stockCountDisplay').innerText = `Tracking ${coreStocks.length} Major Companies (Offline Mode)`;
        }
    }

    function filterStocks() {
        const query = document.getElementById('searchInput').value.toUpperCase();
        document.getElementById('stockGrid').innerHTML = ''; 
        displayCount = 0;
        
        if (!query) {
            currentFilteredStocks = allStocks;
        } else {
            currentFilteredStocks = allStocks.filter(s => s.s.includes(query) || s.n.toUpperCase().includes(query));
        }
        renderBatch();
    }

    async function init() {
        // Initialize with core stocks first for instant load
        allStocks = [...coreStocks];
        currentFilteredStocks = [...allStocks];
        
        // Ticker
        const ticker = document.getElementById('tickerContent');
        ticker.innerHTML = [...coreStocks].sort(() => 0.5 - Math.random()).slice(0, 20).map(s => {
            const d = getStockData(s.s);
            return `<div class="ticker-item" onclick='openModal({s:"${s.s}", n:"${s.n}"})'>${s.s} <span class="${d.isUp?'up':'down'}">${d.isUp?'â–²':'â–¼'} ${d.change}%</span></div>`;
        }).join('');

        renderInvestmentPicks();
        renderMovers();
        renderBatch();

        // Background fetch for the 4000+ list
        await fetchAllNasdaq();
        
        document.getElementById('searchInput').addEventListener('keyup', filterStocks);
        
        // Infinite Scroll
        window.addEventListener('scroll', () => { 
            if (document.documentElement.scrollTop + window.innerHeight >= document.documentElement.scrollHeight - 300) {
                renderBatch();
            }
        });
    }

    window.onload = init;
</script>
</body>
</html>